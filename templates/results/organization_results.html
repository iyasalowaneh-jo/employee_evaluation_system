{% extends "base.html" %}

{% block title %}Organization Results - Employee Evaluation System{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4"><i class="fas fa-building"></i> Organization-Wide Performance Results</h2>

    <div class="alert alert-secondary">
        <i class="fas fa-info-circle"></i>
        Feedback questions are shown based on actual working relationships. Employees are evaluated only on areas where evaluators actively interact with them. Extreme high and low scores are automatically excluded to ensure fairness.
    </div>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle"></i> <strong>Executive Access:</strong> 
        You have full access to view all employee performance results across the organization.
    </div>
    
    <!-- Filters and Sorting -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Filter by Department:</label>
                    <select class="form-select" onchange="window.location.href='{{ url_for('organization_results') }}?department=' + this.value + '&sort={{ current_sort }}'">
                        <option value="all" {% if current_filter == 'all' %}selected{% endif %}>All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}" {% if current_filter == dept %}selected{% endif %}>{{ dept }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Sort by:</label>
                    <select class="form-select" onchange="window.location.href='{{ url_for('organization_results') }}?department={{ current_filter }}&sort=' + this.value">
                        <option value="final_score" {% if current_sort == 'final_score' %}selected{% endif %}>Final Score (High to Low)</option>
                        <option value="kpi_score" {% if current_sort == 'kpi_score' %}selected{% endif %}>KPI Score (High to Low)</option>
                        <option value="feedback_score" {% if current_sort == 'feedback_score' %}selected{% endif %}>360 Score (High to Low)</option>
                        <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name (A-Z)</option>
                        <option value="department" {% if current_sort == 'department' %}selected{% endif %}>Department</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h5>All Employees - {{ cycle.name }}</h5>
            <p class="mb-0 text-muted">Total: {{ org_results|length }} employees</p>
        </div>
        <div class="card-body">
            {% if org_results %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Role</th>
                            <th>Department</th>
                            <th>KPI Score</th>
                            <th>
                                360 Score
                                <i class="fas fa-info-circle text-info" data-bs-toggle="tooltip" title="Trimmed mean: excluding the top 10% and bottom 10% of scores"></i>
                            </th>
                            <th>Final Score</th>
                            <th>Evaluations</th>
                            <th>Confidence</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in org_results %}
                        <tr class="employee-row" data-employee-id="{{ result.employee.employee_id }}">
                            <td>
                                <strong>{{ result.employee.full_name }}</strong>
                                <button class="btn btn-sm btn-link p-0 ms-2 toggle-kpi-details" 
                                        data-target="kpi-details-{{ result.employee.employee_id }}"
                                        title="Show/Hide KPI Details"
                                        aria-label="Show or hide KPI details for {{ result.employee.full_name }}">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </td>
                            <td>{{ result.employee.role }}</td>
                            <td>{{ result.employee.department }}</td>
                            <td>
                                <span class="badge bg-{{ 'success' if result.performance.kpi_score >= 4 else 'warning' if result.performance.kpi_score >= 3 else 'danger' }}">
                                    {{ result.performance.kpi_score }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if result.performance.feedback_score >= 4 else 'warning' if result.performance.feedback_score >= 3 else 'danger' }}">
                                    {{ result.performance.feedback_score }}
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-primary" style="font-size: 1em; padding: 8px 12px;">
                                    {{ result.performance.final_score }}
                                </span>
                            </td>
                            <td>
                                <small class="d-block">KPI: {{ result.performance.kpi_count }} out of {{ result.performance.kpi_expected }}</small>
                                <small class="d-block">360: {{ result.performance.feedback_count }} out of {{ result.performance.feedback_expected }}</small>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle"></i> Confidence based on 360 feedback only (KPI excluded)
                                </small>
                            </td>
                            <td>
                                <div class="progress" style="height: 25px; width: 120px;">
                                    <div class="progress-bar text-white bg-{{ 'success' if result.performance.confidence >= 0.8 else 'info' if result.performance.confidence >= 0.65 else 'warning' if result.performance.confidence >= 0.3 else 'danger' }}" 
                                         role="progressbar" 
                                         style="width: {{ result.performance.confidence_percentage }}%">
                                        <strong>{{ result.performance.confidence_percentage }}%</strong>
                                    </div>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    {{ result.performance.confidence_label }} ({{ result.performance.feedback_count }} evaluator{{ 's' if result.performance.feedback_count != 1 else '' }})
                                </small>
                                {% if result.performance.confidence_pillars %}
                                <button class="btn btn-xs btn-link p-0 mt-1" type="button" data-bs-toggle="collapse" data-bs-target="#pillar_{{ result.employee.employee_id }}" style="font-size: 0.75rem;" aria-label="Show 4-pillar confidence breakdown">
                                    <i class="fas fa-info-circle"></i> Pillars
                                </button>
                                <div class="collapse mt-2" id="pillar_{{ result.employee.employee_id }}">
                                    <div class="card card-body bg-light p-2" style="font-size: 0.75rem;">
                                        <div class="mb-1">
                                            <small><i class="fas fa-users text-primary"></i> Eval: {{ result.performance.confidence_pillars.pillar_1_count }}%</small>
                                        </div>
                                        <div class="mb-1">
                                            <small><i class="fas fa-sitemap text-info"></i> Div: {{ result.performance.confidence_pillars.pillar_2_diversity }}%</small>
                                        </div>
                                        <div class="mb-1">
                                            <small><i class="fas fa-chart-line text-success"></i> Cons: {{ result.performance.confidence_pillars.pillar_3_consistency }}%</small>
                                        </div>
                                        <div>
                                            <small><i class="fas fa-clock text-warning"></i> Rec: {{ result.performance.confidence_pillars.pillar_4_recency }}%</small>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('view_employee_results', employee_id=result.employee.employee_id) }}" 
                                   class="btn btn-sm btn-primary">
                                    <i class="fas fa-eye"></i> View Details
                                </a>
                            </td>
                        </tr>
                        <tr class="kpi-details-row" id="kpi-details-{{ result.employee.employee_id }}" style="display: none;">
                            <td colspan="9">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="mb-3">
                                            <i class="fas fa-chart-line"></i> KPI Breakdown for {{ result.employee.full_name }}
                                        </h6>
                                        {% if result.kpi_breakdown %}
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered">
                                                <thead>
                                                    <tr>
                                                        <th>KPI / Skill</th>
                                                        <th>Average Score</th>
                                                        <th>Weight</th>
                                                        <th>Evaluations</th>
                                                        <th>Status</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for kpi_name, kpi_data in result.kpi_breakdown.items() %}
                                                    <tr>
                                                        <td><strong>{{ kpi_name }}</strong></td>
                                                        <td>
                                                            <span class="badge bg-{{ 'success' if kpi_data.average >= 4 else 'warning' if kpi_data.average >= 3 else 'danger' }}" style="font-size: 0.9em;">
                                                                {{ kpi_data.average }}
                                                            </span>
                                                        </td>
                                                        <td>{{ kpi_data.weight }}%</td>
                                                        <td>{{ kpi_data.count }}</td>
                                                        <td>
                                                            {% if kpi_data.average >= 4 %}
                                                                <span class="badge bg-success">Excellent</span>
                                                            {% elif kpi_data.average >= 3 %}
                                                                <span class="badge bg-warning">Good</span>
                                                            {% else %}
                                                                <span class="badge bg-danger">Needs Improvement</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% else %}
                                        <div class="alert alert-info mb-0">
                                            <i class="fas fa-info-circle"></i> No KPI evaluations available for this employee yet.
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i> No results available for the selected filter.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButtons = document.querySelectorAll('.toggle-kpi-details');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const detailsRow = document.getElementById(targetId);
            const icon = this.querySelector('i');
            
            if (detailsRow.style.display === 'none') {
                detailsRow.style.display = 'table-row';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                detailsRow.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        });
    });
});
</script>
{% endblock %}
